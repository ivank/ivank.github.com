
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Develop Simply</title>
  <meta name="author" content="Ivan Kerin">

  
  <meta name="description" content="So you just want to upload files, maybe resize some images, maybe even do some validation - well you&#8217;re in luck. This quick tutorial will show &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ivank.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Develop Simply" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26866049-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Develop Simply</a></h1>
  
    <h2>Ivan K's development musings</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ivank.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/setting-up-bad-ass-file-uploading/">Setting Up Bad Ass File Uploading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-29T10:52:00+02:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So you just want to upload files, maybe resize some images, maybe even do some validation - well you&#8217;re in luck. This quick tutorial will show you how to do this the easy way with <a href="https://github.com/OpenBuildings/jam">Jam</a>.</p>

<p>First off, lets create a table for our model. We&#8217;ll be using <a href="https://github.com/OpenBuildings/timestamped-migrations">timestamped-migrations</a> for that:</p>

<pre><code>minion db:generate --name=create_table_paintings
&gt; 1351501477_create_table_paintings.php Migration File Generated
</code></pre>

<p>Now we can modify the migration file to add the nesessary fields:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Create_Table_Paintings</span> <span class="k">extends</span> <span class="nx">Migration</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">create_table</span><span class="p">(</span><span class="s1">&#39;paintings&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;file&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">drop_table</span><span class="p">(</span><span class="s1">&#39;paintings&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The id column will be added automatically. You can disable that behavior but its generally useful and in this case saves us some bit of writing. And always having an ID column is a good DB practice anyway.</p>

<p>Now we run the migration to create our paintings table in the database.</p>

<pre><code>minion db:migrate
</code></pre>

<p>We got the table now we can create the model corresponding to the table. Put this file in your <code>APPPATH/classes/model/painting.php</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model_Painting</span> <span class="k">extends</span> <span class="nx">Jam_Model</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">(</span><span class="nx">Jam_Meta</span> <span class="nv">$meta</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$meta</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;file&#39;</span><span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;local&#39;</span><span class="p">)),</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;present&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we add the 3 columns from the table to map them to model fields. Primary field is a special one, used for fining by index later on. As for the &#8216;file&#8217; field - it&#8217;s an &#8220;upload&#8221; field which requires you to set a server for the upload. You will generally keep your files on your local machine - and to do that we set the server to &#8216;local&#8217;, but you can set this to various other server types, for example rackspace cloudfiles or ftp server - and it will upload the files there and display them with the appropriate public URL - but don&#8217;t worry about that for now.</p>

<p>The default upload locations for local are DOCROOT/upload/temp, and DOCROOT/upload/{model}/{id}/ but you can change them in the config. And we also add validation to require the presense of both name and file fields so the model will not be valid if the user does not input any of those two.</p>

<p>So anyway, we now proceed to the controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Controller_Paintings</span> <span class="k">extends</span> <span class="nx">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">action_show</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$painting</span> <span class="o">=</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;painting&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">(</span><span class="nx">View</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;paintings/show&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;painting&#39;</span> <span class="o">=&gt;</span> <span class="nv">$painting</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">action_new</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$painting</span> <span class="o">=</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;painting&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">()</span> <span class="o">===</span> <span class="nx">Request</span><span class="o">::</span><span class="na">POST</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">Upload</span><span class="o">::</span><span class="na">not_empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">check</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span><span class='line'>              <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s1">&#39;paintings/show/&#39;</span><span class="o">.</span><span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">());</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">(</span><span class="nx">View</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;paintings/form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;painting&#39;</span> <span class="o">=&gt;</span> <span class="nv">$painting</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>With the show action we just display the painting, While the secound - &#8220;new&#8221; action does all the work of uploading, validating and saving the model. The uploading magic happens in &#8220;check&#8221; method - we upload the file to the temporary folder and serve it from there, should the validation fail - we will still have the file uploaded so the user will not have to upload it a second time, and we can also display a thumbnail. If everything is OK then ->check() returns TRUE, and in the ->save() method the file gets moved to its final destination.</p>

<p>The corresponding views to make this all work are:</p>

<p><code>APPPATH/views/paintings/form.php</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">form</span><span class="p">(</span><span class="nv">$painting</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">open</span><span class="p">(</span><span class="s1">&#39;paintings/new&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;enctype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;temp_source&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">submit</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s2">&quot;Create Painting&quot;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">close</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p><code>APPPATH/views/paintings/show.php</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;img src=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x">&quot; alt=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x">&quot;/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well that&#8217;s out of the way and we can start palying with this in our browser. But there are still some things we can modify to make this even better. Say you want to limit to uploading to only images, by using the built in uploaded validator, and we&#8217;ll add a thumbnail while we&#8217;re at it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model_Painting</span> <span class="k">extends</span> <span class="nx">Jam_Model</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">(</span><span class="nx">Jam_Meta</span> <span class="nv">$meta</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$meta</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;file&#39;</span><span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>              <span class="s1">&#39;server&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;local&#39;</span>
</span><span class='line'>              <span class="s1">&#39;thumbnails&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                  <span class="s1">&#39;thumb&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                      <span class="s1">&#39;resize&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>          <span class="p">)),</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$this</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;present&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">))</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;uploaded&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum_width&#39;</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;minimum_height&#39;</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can add a thumbnail to form field, so that when the validation fails, we can see the image that&#8217;s already uploaded:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">form</span><span class="p">(</span><span class="nv">$painting</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">open</span><span class="p">(</span><span class="s1">&#39;paintings/new&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;enctype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">object</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">is_empty</span><span class="p">())</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      &lt;img src=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">object</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">(</span><span class="s1">&#39;thumb&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x">&quot; alt=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$painting</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x">&quot;/&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">endif</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;temp_source&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">submit</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s2">&quot;Create Painting&quot;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">close</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The upload Field is very flexible - it can accept different sources for the images, for example you can pass a URL to the field and it will download it. You can use php://input for ajax uploads, or if you upload it manually to the temp dir by any other method (Flash uploader for example) it will work appropriately.</p>

<p>As a last touch we will add 2 columns to the table - file_width and file_height - and set it up so they get automatically populated with the width and height of the image.</p>

<pre><code>minion db:generate --name=add_file_width_and_file_height_to_paintings
minion db:migrate
</code></pre>

<p>Jam Fields only know and can operate on themselves, and can&#8217;t change other fields. So this must be done through a behavior. Luckily there is just such a bihavior.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model_Painting</span> <span class="k">extends</span> <span class="nx">Jam_Model</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">(</span><span class="nx">Jam_Meta</span> <span class="nv">$meta</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$meta</span><span class="o">-&gt;</span><span class="na">behaviors</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;file&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">behavior</span><span class="p">(</span><span class="s1">&#39;uploadable&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>              <span class="s1">&#39;save_size&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;server&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;local&#39;</span>
</span><span class='line'>              <span class="s1">&#39;thumbnails&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                  <span class="s1">&#39;thumb&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                      <span class="s1">&#39;resize&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>          <span class="p">))</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$meta</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jam</span><span class="o">::</span><span class="na">field</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$this</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;present&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">))</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;uploaded&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum_width&#39;</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;minimum_height&#39;</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>And we&#8217;re done. Everytime a new image is uploaded we will get a proper file_width and file_height.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/the-joy-of-func-testing/">The Joy of (Func)Testing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-26T19:42:00+03:00" pubdate data-updated="true">Oct 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Testing in PHP has always been hard - PHP Devs generally just don&#8217;t &#8220;get it&#8221;. There have been some recent developments from Symfony camp, but again they are not easily integratable with Kohana - the framework I&#8217;m most interested in. And the saddest thing is there are great testing frameworks out there in other languages and the fact that nobody has tried to accomplish something similar in PHP is just heartbreaking. I mean - the best answer to &#8220;how to do functional testing in PHP&#8221; is &#8220;selenium with PHPUnit&#8221;, even if what you want to test is just some form input without any javascript - that can get tough on you.</p>

<p>Anyway I rolled up my sleeves and started on the long and perilous journey of writing my own testing framework. Well not exactly - I mostly got the DSL idea from Capybara, and wrote it on top of Kohana Unittest (PHPUnit) but the result is I think quite significant in itself.</p>

<h2><a href="https://github.com/OpenBuildings/functest">FuncTest</a></h2>

<p>The core principles of FuncTest are to be as easy to write the test as possible, and to execute it as fast as possible. Great! But what does that mean in practice? Here&#8217;s an example test, straight from the docs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">myTest</span> <span class="k">extends</span> <span class="nx">FuncTest_TestCase</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">test_finders</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="s1">&#39;/my/url&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">fill_in</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">fill_in</span><span class="p">(</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span> <span class="s1">&#39;john-user&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;Select Year&#39;</span><span class="p">,</span> <span class="s1">&#39;2004&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">check</span><span class="p">(</span><span class="s1">&#39;Recieve Newsletter&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">click_button</span><span class="p">(</span><span class="s1">&#39;Create User&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Looks easy right? Well it will do exactly what you think it would:</p>

<ul>
<li>Go to URL /my/url</li>
<li>Fill in the input tag labeled with &#8216;John&#8217; (yes labeled - like a label tag with a for=&#8217;id&#8217; that matches the id of the input tag)</li>
<li>Fill in the input tag labeled Username with &#8216;john-user&#8217;</li>
<li>Select 2004 from the dropdown labeled &#8216;Select Year&#8217;</li>
<li>Check the checkbox labeled &#8216;Recieve Newsletter&#8217;</li>
<li>Click the button &#8216;Create User&#8217;</li>
</ul>


<p>Why use titles / labels instead of &#8216;name&#8217; attributes or even css selectors, well - if you wanted to you can, and that too is pretty easy, but in my experience the texts change much less frequently than the internal stuff.</p>

<p>And the best part is - this will work with the Kohana classes themselves internally (actually using HMVC patterns for special internal requests) - so there are no network, apache or Kohana framework overhead whatsoever.</p>

<p>And &#8230; just one more thing - if you want to run this in selenium (for ajax testing for example): just add <code>public $driver_name = 'selenium'</code> to your class - and you&#8217;re good to go - the same test will run by actually opening up your browser and filling in these fields.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/managing-unreliability-with-services/">Managing Unreliability With Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-26T19:05:00+03:00" pubdate data-updated="true">Oct 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I&#8217;m gonna introduce the <a href="https://github.com/OpenBuildings/services-manager">services manager module</a>. It&#8217;s probably the project that is most unfinished and a little bit rough around the edges, however even in its current, toddler state it can seriously reduce the complexity of relying on 3rd party services. What you can do with it is encapsulate all the code needed to talking with a 3rd party service - be it Google Analytics, Facebook SDK or even Beanstalkd queue in a single class / library. But not any old class - it&#8217;s built around the idea that if a service goes &#8220;oops&#8221; and doesn&#8217;t work anymore for whatever reason - you can disable it and still have a working application. Having such a separation is also great if you want to have different services working in Testing / Development / Production (or even working with different configs). Additionally each service handles its own javascript / css inclusions so this happens transparently to you. You can even say &#8220;I want to run this service in development, but on production I want only normal users to see it, exclude the admins&#8221;.</p>

<p>You might tell yourself &#8220;why do I need this, including a bunch of Google Analytics code is not that hard&#8221; - and you would be right - but the more services you rely on the harder it gets to manage them (like - exponentially harder), so why not make your life easier from the beginning.</p>

<p>So, lets try a concrete example - we want to add Google Analytics. Our config code would look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct access allowed.&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">return</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;services&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;googleanalytics&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;api-key&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;{api key}&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;enabled&#39;</span> <span class="o">=&gt;</span> <span class="nx">Kohana</span><span class="o">::</span><span class="nv">$environment</span> <span class="o">===</span> <span class="nx">Kohana</span><span class="o">::</span><span class="na">PRODUCTION</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;disabled-for-role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">),</span>
</span><span class='line'>  <span class="p">),</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>And you will need to have a <code>&lt;?php echo Service::all_bodies(); ?&gt;</code> in the end of your main HTML template body, and <code>&lt;?php echo Service::all_heads(); ?&gt;</code> in the head tag of the template, allowing any service to position its asset files in the most convenient location. But that&#8217;s about it - you now have a service that works only in Production environment, and even then it will be disabled for logged in users that have the role &#8220;admin&#8221; - pretty neat, ah?</p>

<p>There is a lot of built in services already available, for example, enabling chartbeat is just a few lines of config:</p>

<pre><code>'chartbeat' =&gt; array(
    'enabled' =&gt; Kohana::$environment === array(Kohana::PRODUCTION,
    'config' =&gt; array('uid' =&gt; 'your key' , 'domain' =&gt; 'your domain'),
),
</code></pre>

<p>And you don&#8217;t have to worry where the javascript will go, and not tracking people in dev environment, and generally makes you a more happy developer.</p>

<p>But the main idea is that any service is easily converted to this system and you can create your own services for internal APIs and whatnot with the same flexibility of deployment. You just have to override the relevant abstract methods and you&#8217;re good to go.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/new-opensoure-libraries/">New Open Source Libraries</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-26T14:55:00+03:00" pubdate data-updated="true">Oct 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve always been a believer that in order to write first class code, one has to write it as if they will be released in the wild - with all the consistency, documentation and general bad-ass-ness that it requires. And that&#8217;s the test I generally use to find out if I&#8217;ve written a mess - &#8220;Can I release this in the wild with my name attached to it&#8221;. Well if the answer is &#8220;yes&#8221; and I will not have the urge to hide in a dark corner whenever I see someone else using it, then what the hell, why not actually release it.</p>

<p>So to put my money where my mouth is, here are the libraries that I&#8217;ve decided to release open source. They are all Kohana 3.2 modules for now, with the ambition to upgrade them to 3.3 in the near future.</p>

<ul>
<li><a href="https://github.com/OpenBuildings/jam">Jam</a> - ORM replacement module, inspired by Kohana Jelly</li>
<li><a href="https://github.com/OpenBuildings/jam-auth">Jam Auth</a> - user authentication and permissions with Jam, as well as external service login support (e.g. facebook)</li>
<li><a href="https://github.com/OpenBuildings/services-manager">Services Manager</a> - A library to encapsulate talking to external services, with different configs for different environments</li>
<li><a href="https://github.com/OpenBuildings/functest">FuncTest</a> - Functional Testing, inspired by ruby&#8217;s Capybara, with selenium and native drivers</li>
<li><a href="https://github.com/OpenBuildings/jamaker">Jamaker</a> - A Database population tool, inspired by Factory Girl</li>
</ul>


<p>These are all great tools that we use daily in production and have a lot of documentation and examples in their respective README&#8217;s, I&#8217;ll be really happy to get some feedback on these.</p>

<p>Also, some of the previously released libraries have been updated</p>

<ul>
<li><a href="https://github.com/OpenBuildings/timestamped-migrations">Timestamped Migrations</a> - moved to kohana minion, more options, docs and consistency throughout.</li>
<li><a href="https://github.com/OpenBuildings/asset-merger">Assets Merger</a> - added automatic tests to make sure the processors work.</li>
</ul>


<p>I&#8217;ll try to present each one of these libraries on its own in future posts, but for now you can check out the docs of the libraries themselves.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/jamming-to-the-future/">Jamming to the Future</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-26T12:55:00+03:00" pubdate data-updated="true">Oct 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s been a long time since my last publication, but I&#8217;ve not been gone to a deserted island or anything, just working quietly in the shadows. And I think I am at last ready to come out and introduce what I and the Clippings team have been working on for so long. But first a very quick history tour.</p>

<p>The Kohana framework is really great most of the time - great request handling, caching, module management, database query building etc., where I find it somewhat lacking (and I mean like What-the-hell-guys-put-your-shit-together type) - is the ORM. Yes it works for most of the basic use cases but its only a very thin layer over the Database builder. By the time we started the project there was <a href="http://jelly.jonathan-geiger.com/">Jelly</a> - a really inspired little ORM that promised a lot and did it with very little clean and concise code. I immoderately fell in love and started using it instead the built in ORM - and it was working great, up until the point I realized that it was a &#8220;dead&#8221; project and nobody actually added new stuff to it. No problem - I like to extend things - so little by little small pieces of code were added to the project by us and at one point I just decided - this is not Jelly anymore! And so we now have a new feature rich library for handling database persistence - <a href="https://github.com/OpenBuildings/jam">Jam</a>.</p>

<p>While the Jam library is a spiritual successor of Jelly, the internals are quite different because of the loads of bundled up functionality that had to be added. Because it was developed over time over the Jelly code base, some of its design don&#8217;t fit particularly well and will probably be replaced by a more consistent interface in the near future. And I had to remove the eager loading functionality (load_with()), which in my tests performed worse than simply loading all the models anyway, however, you gain quite a lot in return - stuff like:</p>

<ul>
<li>Lazy loading of collections - the query is executed at the last possible moment so you can easily cache it in your views.</li>
<li>Build in validation in the model, Active record style - no more unhanded exceptions and weird error message file locations, and validation rules are handled much more developer friendly</li>
<li>Polymorphism - polymorphic &#8216;belongs to&#8217; and &#8216;has many&#8217;</li>
<li>Uploading files to different back ends transparently (local, Rackspace, FTP), and by different means (Ajax uploads, URLs)</li>
<li>Built in behaviors - Paranoid, Sluggable, Nested, Sortable, Uploadable</li>
<li>HTML Form builder with automatic errors integration and nested associations</li>
</ul>


<p>And these are just off the top of my head - there are many many small additions and fixes, and most importantly tons of documentation for the existing functionality.</p>

<p>So take a look at <a href="https://github.com/OpenBuildings/jam">Jam</a> (and the corresponding <a href="https://github.com/OpenBuildings/jam-auth">Jam Auth</a>) and tell me what you think.</p>

<hr />

<p>P.S. Kudos to Jonathan Geiger and all of the maintainers of the jelly project - it really is a great inspiration. I tried to hold the spirit of jelly true, but with all the new functionality that had to be added I sort of abandoned the idea of &#8220;keeping it really small&#8221; and went with &#8220;add a lot of useful features&#8221; approach.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/writing-custom-widgets-for-form-builder/">Writing Custom Widgets for Form Builder</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-27T02:29:00+02:00" pubdate data-updated="true">Nov 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Normal Widget</h2>

<p>In the last post <a href="http://ivank.github.com/blog/2011/11/introducing-kohana-form-builder/">about the form builder</a> for <a href="http://kohanaframework.org/">Kohana 3.2</a> I&#8217;ve showed some basic examples of using the library. It&#8217;s great for when you quickly want to build a form and be done with it, but what if you have something more specific in mind - for example, a widget to display a rich textarea. (using CKEditor)</p>

<p>So here we go - in order to write a custom widget we first need to create a class to hold the widget itself (all widgets are just static methods in some a class). The class must start with Form_Widgets_. So we create one named Form_Widgets_Custom</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Form_Widgets_Custom</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">richtextarea</span><span class="p">(</span><span class="nx">Form_Widget</span> <span class="nv">$data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;data-type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;rich&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">merge_as_data</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nx">Form</span><span class="o">::</span><span class="na">textarea</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">as_array</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s a pretty simple widget from PHP&#8217;s perspective - we assign a custom attribute (to anchor our JS). Also - <code>$data-&gt;attribute()</code> is not just a simple associative array - it has some helper methods, and one of them is <code>-&gt;merge_as_data()</code> it will perform the same thing as the code above it - merge the array to itself, except it will prefix every key with &#8220;data-&#8221; so they become proper HTML5 attributes. So the JS, using jQuery will end up looking like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;textarea[data-type=rich]&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">ckeditor</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">(),</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">()</span> <span class="p">},</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">()));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can call this custom widget in any form from now on like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;custom::richtextarea&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Multiple Fields Widget</h2>

<p>I&#8217;ve had to implement a &#8220;location&#8221; widget, that would allow inputing an address field, showing you the actual location of the address in Google maps, and the ability to move the marker and set a different location for the same address, not the one provided by Google maps. This requires at least one more field, probably two (latitude and longitude).</p>

<p>Each widget takes a <code>Form_Widget</code> class as an argument which has all the information required to build a widget (name, value, attributes, etc.) But that&#8217;s for only one field, what if we want some more fields in the same widget - as it happens you can do that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;custom::location&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lon&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p><code>$data-&gt;name()</code>, <code>$data-&gt;value()</code> return the name and value of the first field respectfully - but if you have multiple fields, you can get them with <code>$data-&gt;items('lat')-&gt;name()</code>. So this will work like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Form_Widgets_Custom</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">location</span><span class="p">(</span><span class="nx">Form_Widget</span> <span class="nv">$data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data-location&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;location&#39;</span><span class="p">));</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$html</span> <span class="o">=</span> <span class="nx">Form</span><span class="o">::</span><span class="na">input</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">as_array</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span> <span class="k">AND</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nv">$html</span> <span class="o">.=</span> <span class="nx">Form</span><span class="o">::</span><span class="na">hidden</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;data-type&quot;</span> <span class="o">=&gt;</span> <span class="s1">&#39;location-lat&#39;</span><span class="p">));</span>
</span><span class='line'>          <span class="nv">$html</span> <span class="o">.=</span> <span class="nx">Form</span><span class="o">::</span><span class="na">hidden</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(),</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;data-type&quot;</span> <span class="o">=&gt;</span> <span class="s1">&#39;location-lon&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$html</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>    
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the attributes of the main input field with the <code>$data-&gt;attribute()</code>. There are 2 main groups of methods on the Form_Widget passed to our method:</p>

<ol>
<li>Field Related - those are <code>-&gt;name()</code>, <code>-&gt;value()</code>, <code>-&gt;field_name()</code>, <code>-&gt;label()</code>, <code>-&gt;id()</code> and <code>-&gt;errors()</code>. All of those return values related to first field, but if there are multiple fields, you can access them through the <code>-&gt;items()</code> and <code>-&gt;item(&lt;name&gt;)</code> methods - each item has all those methods too.</li>
<li>Everything else - <code>-&gt;attributes()</code>, <code>-&gt;options()</code>, <code>-&gt;required()</code> - those operate on the widget itself.</li>
</ol>


<h2>Widget Slots</h2>

<p>If you want to get really funky with your widget you can tap into the &#8220;slots&#8221; functionality - you see, the return of the widget method is passed into the :field slot inside the template, but you can modify that directly, set other slots, or even not set a :field slot at all</p>

<p>A simple example of how this all works is this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Form_Widgets_Custom</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">checkbox</span><span class="p">(</span><span class="nx">Form_Widget</span> <span class="nv">$data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>        
</span><span class='line'>      <span class="k">return</span> <span class="nx">Form_Widgets</span><span class="o">::</span><span class="na">checkbox</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">swap_slots</span><span class="p">(</span><span class="s2">&quot;:label&quot;</span><span class="p">,</span> <span class="s2">&quot;:field&quot;</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>With this we use the default checkbox widget, but swap the slots of the field and label in the template (so that the input appears before the label). You can modify the template directly through <code>$data-&gt;template(&lt;new template&gt;)</code> and you can set slots, default ones or your own with <code>$data-&gt;slots('name', 'slot content')</code></p>

<h2>Custom Form Builder</h2>

<p>Alright so you&#8217;ve made a couple of custom widgets, but what you want is a custom style to all your widgets, in that case you can write a custom form builder class that sets the desired parameters to all the widgets it creates. Here&#8217;s an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Form_Builder_Jelly_Admin</span> <span class="k">extends</span> <span class="nx">Form_Builder_Jelly</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">row</span><span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$attributes</span> <span class="o">=</span> <span class="k">null</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$help</span> <span class="o">=</span> <span class="nx">Arr</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$options</span><span class="p">,</span> <span class="nv">$attributes</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$errors</span> <span class="o">=</span> <span class="nb">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nx">Arr</span><span class="o">::</span><span class="na">flatten</span><span class="p">((</span><span class="k">array</span><span class="p">)</span> <span class="nv">$field</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()));</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$field</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">slots</span><span class="p">(</span><span class="s2">&quot;:errors&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;span class=</span><span class="se">\&quot;</span><span class="s2">help-inline</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="nv">$errors</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">slots</span><span class="p">(</span><span class="s2">&quot;:with-errors&quot;</span><span class="p">,</span> <span class="nv">$field</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span> <span class="o">?</span> <span class="s1">&#39;error&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">slots</span><span class="p">(</span><span class="s2">&quot;:help&quot;</span><span class="p">,</span> <span class="nv">$help</span> <span class="o">?</span> <span class="s2">&quot;&lt;span class=</span><span class="se">\&quot;</span><span class="s2">help-block</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">$help</span><span class="s2">&lt;/span&gt;&quot;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">render</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//Set some custom parameters in the widget object, used by &quot;row&quot; and &quot;field&quot; methods</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">widget</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">widget</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="na">template</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;clearfix :name-field :type-field :with-errors&quot;&gt;:label&lt;div class=&quot;input&quot;&gt;:field:errors:help&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>So now you have a custom &#8220;help&#8221; option that every widget has, as well as custom error message and a custom template.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/introducing-kohana-form-builder/">Introducing Kohana Form Builder</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-26T18:53:00+02:00" pubdate data-updated="true">Nov 26<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a history with forms - all kinds of them - <em>Symfony Forms</em>, <em>Cake Forms</em>, <em>Kohana Forms</em>, <em>Rails Forms</em> - you name it. And every form builder had something missing - some feature that I had to build, some misconception about what is really desired of the builder. Some got it better than others - for example I am a big fan of rails form helper thingie. It has a ease-of-use feel to it that I hadn&#8217;t encountered elsewhere - but it does have some missing features that I always ended up implementing myself. Symfony on the other hand has quite a lot of features but it feels so complicated and cumbersome to use that I often don&#8217;t even bother. So I needed a form builder for <a href="http://kohanaframework.org/">Kohana 3.2</a> and decided to build one that had everything I dreamed of having - of course I ended up with a lot of compromises - but the result so far looks quite satisfying - <a href="https://github.com/OpenBuildings/form-builder">form-builder</a></p>

<h2>Requirements</h2>

<p>I&#8217;ve put a lot of effort to make writing forms as effortless as possible. There are some basic requirements that I want out of the form builder module:</p>

<ol>
<li><strong>Configurability</strong> - every project&#8217;s forms have different requirements of &#8220;when to show what&#8221; - this had to be implemented in such a way that you would be able to go straight down to HTML and basic PHP to customize your forms, preferably in a repeatable way.</li>
<li><strong>Jelly integration</strong> - you would probably have a lot of logic for validation and fields themselves already - I wanted to tap into this instead of duplicating it elsewhere.</li>
<li><strong>Stand on their own</strong> - but sometimes you do want to build forms without a specific jelly model attached to it, maybe with just a Validation object, or no object at all</li>
<li><strong>Nested forms</strong> - you might say that this is too specific and rarely used - but in every single project I dealt with there had to be at least one nested form - and it&#8217;s such a basic concept that I did want it to work right out of the box</li>
<li><strong>Extensibility</strong> - you must be able to write new widgets easily - with different properties - multiple fields, with required or optional parameters and to have access to the whole model</li>
<li><strong>Ease of writing</strong> - writing HTML forms in your templates should be easy and concise - period.</li>
</ol>


<p>I&#8217;ve tried to address all of those properly and if I&#8217;ve strayed off this path I would be happy to receive suggestions how to get back on track :)</p>

<h2>Example</h2>

<p>So here&#8217;s an actual example of a form:</p>

<p>The Controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Controller_Users</span> <span class="k">extends</span> <span class="nx">Controller_Template</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">action_edit</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//Load </span>
</span><span class='line'>      <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Jelly</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="nv">$form</span> <span class="o">=</span> <span class="nx">Form_Builder</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Request</span><span class="o">::</span><span class="na">POST</span> <span class="k">AND</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">check</span><span class="p">())</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span><span class='line'>          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s2">&quot;/success&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">View</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>And the view:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Form</span><span class="o">::</span><span class="na">open</span><span class="p">(</span><span class="s1">&#39;/edit&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;fieldset&gt;</span>
</span><span class='line'><span class="x">  &lt;legend&gt;Basic Info&lt;/legend&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;checkboxes&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;choices&#39;</span> <span class="o">=&gt;</span> <span class="nx">Jelly</span><span class="o">::</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">()))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;/legend&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">  &lt;fieldset&gt;</span>
</span><span class='line'><span class="x">  &lt;legend&gt;About&lt;/legend&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;checkbox&#39;</span><span class="p">,</span> <span class="s1">&#39;receive_newsletter&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;span8&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;span12&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;/fieldset&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">  &lt;fieldset&gt;</span>
</span><span class='line'><span class="x">  &lt;legend&gt;Contacts&lt;/legend&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;website&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;twitter&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;facebook&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;/fieldset&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That form is sufficient to view and edit the user&#8217;s properties, displaying errors on fail when appropriate and it&#8217;s all quite self-explanatory - the only concept different from the already established ones in Kohana and Jelly is the concept of &#8220;widgets&#8221; - you basically have functions that construct some kind of input tags - in this example they are <code>input</code>, <code>textarea</code>, <code>checkbox</code> and <code>checkboxes</code>. All of this is explained in the README</p>

<p>The icing on the cake is that it reads Jelly Model&#8217;s rules and places html5 form validation whenever possible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/big-update-to-migration/">Big Update to Migration</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-12T20:41:00+02:00" pubdate data-updated="true">Nov 12<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was talking to the guys in the Kohana forum and the subject of &#8220;why should I use <a href="https://github.com/jmhobbs/kohana-3-migrations">timestamped-migrations</a> instead of minion&#8217;s migrations&#8221; came up. Why indeed. So I decided to up the game a bit. Doing funky stuff like reading the changes from the local database and then syncing those back to production is a bit too fragile for my tastes, and at least with RDBMS i want to be <em>really</em> sure what&#8217;s going to happen and what SQL queries will run, so I&#8217;m trying to reduce the &#8220;magic&#8221; as much as possible. There is however a lot of room for improvement, so what I ended up implementing was rails-style parsing of the filename to generate.</p>

<h2>Migration Name Parsing</h2>

<p>So imagine you want to make a migration like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php kohana db:generate add_created_at_and_title_to_users
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Now, the tool should be savvy enough to read this filename and at least guess what you want to accomplish. And now it is. Behold:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Add_Created_At_And_Title_To_Users</span> <span class="k">extends</span> <span class="nx">Migration</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;string[255]&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;string[255]&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">remove_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">remove_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s not perfect, and you still have to tweak it a bit (change the type of created_at to a timestamp maybe) but it&#8217;s a whole lot easier than having a blank migration file.</p>

<p>But where this functionality really shines is when you want to drop some tables / columns.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php kohana db:generate drop_table_roles
</span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Drop_Table_Roles</span> <span class="k">extends</span> <span class="nx">Migration</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">drop_table</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">create_table</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span> <span class="s1">&#39;string[32]&#39;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span> <span class="s1">&#39;string[255]&#39;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">),</span> <span class="k">array</span><span class="p">(</span> <span class="s1">&#39;engine&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;InnoDB&#39;</span> <span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>You no longer have to go through the current database to write your own down statement, this data is accessible to the tool, so it does the work for you. Of course if the table does not exist it behaves like normal and you still have to write your own down statement.</p>

<p>So Available patterns right now are:</p>

<ul>
<li>create_table_{table}</li>
<li>drop_table_{table}</li>
<li>add_{columns}_to_{table}</li>
<li>remove_{columns}_from_{table}</li>
<li>change_{columns}_in_{table}</li>
<li>rename_table_{old_name}_to_{new_name}</li>
<li>rename_{old_name}_to_{new_name}_in_{table_name}</li>
</ul>


<p>And you can write several {columns} if you separate them with <strong>_and_</strong> and you can also write several patterns, separated with <strong>_also_</strong> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php kohana db:generate drop_table_roles_also_add_name_and_title_to_authors
</span></code></pre></td></tr></table></div></figure>


<p>It will order the statements in the up and down methods of the migration correctly too.</p>

<h2>Dry Runs</h2>

<p>There&#8217;s now the ability to run the migrations and see what they do, without actually doing anything. Just add a &#8211;dry-run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php kohana db:migrate --dry-run
</span><span class='line'>1321124936 Add_Created_At_And_Title_To_Users : migrating up -- Dry Run
</span><span class='line'>-- <span class="o">[</span>dry-run<span class="o">]</span>add_column<span class="o">(</span> users, created_at <span class="o">)</span>
</span><span class='line'>   --&gt; 0.0000s
</span><span class='line'>-- <span class="o">[</span>dry-run<span class="o">]</span>add_column<span class="o">(</span> users, title <span class="o">)</span>
</span><span class='line'>   --&gt; 0.0000s
</span><span class='line'>1321124936 Add_Created_At_And_Title_To_Users : migrated <span class="o">(</span>0.0001s<span class="o">)</span>
</span><span class='line'>1321124960 Drop_Table_Roles_Also_Add_Name_And_Title_To_Authors : migrating up -- Dry Run
</span><span class='line'>-- <span class="o">[</span>dry-run<span class="o">]</span>drop_table<span class="o">(</span> roles <span class="o">)</span>
</span><span class='line'>   --&gt; 0.0000s
</span><span class='line'>-- <span class="o">[</span>dry-run<span class="o">]</span>add_column<span class="o">(</span> authors, name <span class="o">)</span>
</span><span class='line'>   --&gt; 0.0000s
</span><span class='line'>-- <span class="o">[</span>dry-run<span class="o">]</span>add_column<span class="o">(</span> authors, title <span class="o">)</span>
</span><span class='line'>   --&gt; 0.0000s
</span><span class='line'>1321124960 Drop_Table_Roles_Also_Add_Name_And_Title_To_Authors : migrated <span class="o">(</span>0.0001s<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So no worries.</p>

<h2>Execute SQL</h2>

<p>After adding the dry run ability the need for a dedicated method to execute arbitrary SQL arose - so it will not execute on the dry run. You can now do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">$this-&gt;execute( &quot;INSERT INTO `roles` (`id`, `name`, `description`) VALUES(1, &#39;login&#39;, &#39;Login privileges, granted after account confirmation&#39;)&quot;);</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when you make a dry run this will not execute.</p>

<h2>Bug Fixes</h2>

<p>A nasty bug was fixed when when you specified already executed migration with &#8211;version it would execute all the others. Anyway, you should sleep happy now.</p>

<p>Check out the code: <a href="https://github.com/jmhobbs/kohana-3-migrations">timestamped-migrations</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/timestamped-migrations/">Timestamped Migrations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-07T22:51:00+02:00" pubdate data-updated="true">Nov 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>All non-trivial web projects that use RDBMS need some sort of database migration system to manage database changes and schema evolution. But the tools for that for <a href="http://kohanaframework.org/">Kohana 3</a> are of course &#8230; you got it - lacking. There is <a href="https://github.com/jmhobbs/kohana-3-migrations">Kohana-3-migraitons</a> - but versioned migrations work only for a single developer - if that&#8217;s your situation - I envy you, I really do - so much less headache. But when you try to collaborate database changes, especially with git/svn managing your files - you soon start to say very inappropriate words, very very loudly. So I went on and rewrote null77&#8217;s excellent module <a href="http://code.google.com/p/kohana-migrations/">kohana-migrations</a> for Kohana 3 - <a href="https://github.com/OpenBuildings/timestamped-migrations">Timestamped Migrations</a>, but with some more sugar.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/OpenBuildings/timestamped-migrations.git modules/timestamped-migrations
</span></code></pre></td></tr></table></div></figure>


<p>Or</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git submodule git://github.com/OpenBuildings/timestamped-migrations.git modules/timestamped-migrations
</span><span class='line'>git submodule update --init
</span></code></pre></td></tr></table></div></figure>


<p>So now your migrations will look like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>1319717756_initial.php
</span><span class='line'>1319717856_migrate_users_and_roles.php
</span></code></pre></td></tr></table></div></figure>


<p>Might seem a bit too verbose, but it&#8217;s a godsend when you have more than one person on a project - you can just drop a migration file and have it execute in just the right place and order - delightfully convenient.</p>

<p>I personally detest web interfaces for those kind of tasks - exposing system tools to a webserver seem &#8230; unclean, so I&#8217;ve ditched the controllers and views, and implemented simple CLI for this, using <a href="https://github.com/OpenBuildings/kohana-cli">Kohana-cli</a> and mimicking rails&#8217; syntax as much as possible. Check it out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kohana db:version
</span><span class='line'>kohana db:migrate
</span><span class='line'>kohana db:migrate:up
</span><span class='line'>kohana db:migrate:down --step<span class="o">=</span>4
</span><span class='line'>kohana db:migrate:redo --version<span class="o">=</span>1319717756
</span><span class='line'>kohana db:rollback
</span></code></pre></td></tr></table></div></figure>


<p>You can read all about it at the github <a href="https://github.com/OpenBuildings/timestamped-migrations/blob/master/README.md">README file</a>. Enjoy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/command-line-interfaces-rule/">Command Line Interfaces Rule</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-07T22:02:00+02:00" pubdate data-updated="true">Nov 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>All the proper web framework those days have some sort of Command line tools - the first that I&#8217;ve personally encountered where rails and symfony and I haven&#8217;t been able to live without them ever since, but <a href="http://kohanaframework.org/">Kohana 3</a> seems to be awfully backwards in that respect - no CLI in 2.3 and now no CLI in Kohana 3. They did structure it very well to create those tools - its just the tools themselves seem to be missing. Anyway here&#8217;s my take on this.</p>

<p><a href="https://github.com/OpenBuildings/kohana-cli">Kohana-cli</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/OpenBuildings/kohana-cli.git modules/kohana-cli
</span></code></pre></td></tr></table></div></figure>


<p>Or</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git submodule git://github.com/OpenBuildings/kohana-cli.git modules/kohana-cli
</span><span class='line'>git submodule update --init
</span></code></pre></td></tr></table></div></figure>


<p>To use it properly after you&#8217;ve downloaded the module you have to symlink or copy the kohana file from the root module directory to your root directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp modules/kohana-cli/kohana ./
</span><span class='line'>
</span><span class='line'>php kohana <span class="nb">help</span>
</span><span class='line'>./kohana <span class="nb">help</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or if you want system-wide support</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp modules/kohana-cli/kohana /usr/local/bin/
</span><span class='line'>
</span><span class='line'>kohana <span class="nb">help</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright - so now you&#8217;re set to explore what commands you have</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kohana list
</span></code></pre></td></tr></table></div></figure>


<p>This will go through all your modules and search for specially designated &#8220;command&#8221; folders which contain cli scripts. Now several of my own modules have predefined command line utilities but <code>kohana-cli</code> comes with some useful ones itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kohana cache:clear
</span><span class='line'>kohana module:generate
</span></code></pre></td></tr></table></div></figure>


<p>You can get help for the commands with the usual syntax</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kohana <span class="nb">help </span>cache:clear
</span><span class='line'>kohana <span class="nb">help </span>module:generate
</span></code></pre></td></tr></table></div></figure>


<p>And it&#8217;s ridiculously easy to write your own CLI commands with color output and all that check out <code>cache:clear</code>&#8217;s source:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Command_Cache</span> <span class="k">extends</span> <span class="nx">Command</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">const</span> <span class="no">CLEAR_BRIEF</span> <span class="o">=</span> <span class="s2">&quot;Clear system cache and Cache&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">clear</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//Call function and profile its start and end, last argument is the color of the output.</span>
</span><span class='line'>      <span class="nx">self</span><span class="o">::</span><span class="na">log_func</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nx">Cache</span><span class="o">::</span><span class="na">instance</span><span class="p">(),</span> <span class="s1">&#39;delete_all&#39;</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="nx">Command</span><span class="o">::</span><span class="na">OK</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">self</span><span class="o">::</span><span class="na">log_func</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span><span class="o">.</span><span class="nx">Kohana</span><span class="o">::</span><span class="nv">$cache_dir</span><span class="o">.</span><span class="s2">&quot;/*&quot;</span><span class="p">),</span> <span class="nx">Command</span><span class="o">::</span><span class="na">OK</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/setting-up-bad-ass-file-uploading/">Setting up bad ass file uploading</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/the-joy-of-func-testing/">The joy of (Func)Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/managing-unreliability-with-services/">Managing Unreliability with Services</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/new-opensoure-libraries/">New open source libraries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/jamming-to-the-future/">Jamming to the future</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/openbuildings">@openbuildings</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'openbuildings',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/ikerin@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Ivan Kerin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
